<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>GeoNIS Spatial Data Report</title>
<link rel="stylesheet" type="text/css" href="css/report.css" />
<link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
<script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
<script type="text/javascript">
function getPID() {
    var searchStr = window.location.search;
    if (searchStr.length > 1) {
        searchStr = searchStr.substring(1);
    }
    else {
       return "";
    }
    searchItems = searchStr.split('&');
    for(var i = 0; i < searchItems.length; i++) {
        var item = searchItems[i].split('=');
        if (item[0] == "packageid") {
            return item[1];
        }
    }
    return "";
}

function createLinks(errReport) {
    if (typeof errReport !== 'undefined') {
        var regex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return errReport.replace(regex, "<a href='$1'>$1</a>");
    }
    else {
        return errReport;
    }
}

/**
 * Parse the raw error report which we fetched from the database using the
 * Search service, which has the following pipe-delimited structure:
 * error report | JSON string containing various package + entity information
 */
function parseReport(rawReport) {
    splitPipe = rawReport.split('|');
    report = "<ul><li>" + splitPipe[0];
    var validEnding = report.charAt(report.length-1) !== '.' && 
        report.charAt(report.length-1) !== '!' && 
        report.charAt(report.length-1) !== '?';
    if (validEnding) {
        while (report.charAt(report.length-1) == ' ') {
            report = report.slice(0, -1);
        }
        report += '.';
    }
    report += "</li>";
    return {
        'report': report,
        'biography': JSON.parse(splitPipe[1])
    };
}

/** 
 * Check the package and entity tables for error reports, and append them to the
 * active error report if found.
 */
function checkTables(biography, report) {
    report = (biography['entityname'] === null) ? 
        checkPackage(biography, report) : checkEntity(biography, report);
    return report;
}

/**
 * Check for report entries in the entity table, and append them to its error report.
 */
function checkPackage(biography, report) {
    report = "<span class='entity-name'>Package " + biography['packageid'] + 
            "</span>" + report;
    return report;
}

/**
 * Check for report entries in the entity table, and append them to its error report.
 */
function checkEntity(biography, report) {
    var mapService = (biography['mxd'] === null) ?
        biography['entityname'] + " is not available as a map service due to errors." :
        "<a href='" + biography['service'].split('/').slice(0, -1).join('/') + "'>" + 
            biography['entityname'] + " is available as a map service.</a>"
    var spatialType = (biography['israster'] === 't') ? "raster" : "vector";
    report = "<span class='entity-name'>" + biography['entityname'] + "</span> \
        (" + spatialType + ")" + report + "<li>" + mapService + "</li>";
    return report;
}

/**
 * Replaces the default "Searching for package..." with a readable site ID: revision
 * banner, and determines whether this package was retrieved from the staging
 * (pasta-s.lternet.edu) or live (pasta.lternet.edu) server.
 */
function generateBanner(biography) {
    if (biography['scope'] !== 'undefined') {
        document.getElementById("pid").innerHTML = biography['scope'].toUpperCase() + 
            " " + biography['identifier'] + ", revision " + biography['revision'];
    }
    var serverInfo;
    if (biography['pasta'].indexOf('pasta-s') !== -1) {
        serverInfo = {
            'server': 'staging',
            'baseURL': 'pasta-s.lternet.edu'
        };
    }
    else {
        serverInfo = {
            'server': 'live',
            'baseURL': 'pasta.lternet.edu'
        };
    }
    return serverInfo;
}
</script>
</head>
<body>
<div class="wrapper">
<div id="body_wrapper">

    <div id="header">
        <div id="header-content">
            <div id="site_title"><h1>GeoNIS Spatial Data Report</h1></div>
        <div class="cleaner"></div>
        </div>
    </div>

    <div id="wrapper">
        <div id="banner">
            <h2 id="pid">Searching for package...</h2>
            <div id="report"></div>
            <!--<div id="biography"></div>-->
            <div id="workflow-info"></div>
            <div class="push"></div>
        </div>
        <div id="site-report"></div>
        <div class="cleaner"></div> 
    </div>

    <div class="cleaner"></div>
</div>

<div id="footer_wrapper">
    <div id="footer-outer">
        <div id="footer">
            <div id="copyright">
                Copyright &copy; 2013 <a href="http://www.lternet.edu/">Long Term Ecological Research Network</a>
            </div> 
        </div> 
    </div>
</div>

<script type="text/javascript">
var pid = getPID();
if (pid != "") {
    document.getElementById("pid").innerHTML = pid;
    var reportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+%3D+%27" + pid + "%27&returnGeometry=true&outFields=report&f=pjson"
    var requestObj = new XMLHttpRequest();
    requestObj.onreadystatechange = function() {
        if (requestObj.readyState == 4 && (requestObj.status == 200 || requestObj.status == 304)) {
            var responseJson = requestObj.responseText;
            var response = JSON.parse(responseJson);

            // The error report is pipe-delimited from other useful info stored in
            // the report field, in stringified-JSON format
            var replaceBanner = false;
            for (var i = 0; i < response.features.length; i++) {

                // First parse the raw report
                parsedReport = parseReport(response.features[i].attributes.report);
                var report = parsedReport.report;
                var biography = parsedReport.biography;
                report = checkTables(biography, report);
                
                // Generate a banner with the site name, id, and revision, if we haven't
                // done so already
                if (!replaceBanner) {
                    var serverInfo = generateBanner(biography);
                    replaceBanner = true;
                }

                // Insert the reports into the report div
                if (i == 0) {
                    document.getElementById('report').innerHTML = "<p>" + report + "</p></ul>";
                }
                else {
                    var nextReport = document.createElement('div');
                    nextReport.innerHTML = "<p>" + report + "</p></ul>";
                    while (nextReport.firstChild) {
                        document.getElementById('report').appendChild(nextReport.firstChild);
                    }
                }
            }
            
            // Append server information and download link to the bottom of the report
            var packageLink = "<a href='https://" + serverInfo['baseURL'] + "/package/eml/" +
                biography['packageid'].split('.')[0] + "/" + biography['identifier'] +
                "/" + biography['revision'] + "'>" + biography['packageid'] + "</a>";
            document.getElementById('workflow-info').innerHTML = "<hr />\
                <em>Package " + packageLink + " was downloaded from the " + serverInfo.server + 
                " server (<a href='https://" + serverInfo.baseURL + "'>" + serverInfo.baseURL + 
                "</a>) on " + biography['downloaded'].split(' ')[0] + " at " + 
                biography['downloaded'].split(' ')[1].split('.')[0] + " MDT.</em>";

            /*var showBio = '';
            for (var key in biography) {
                if (biography.hasOwnProperty(key)) {
                    showBio = showBio + "<li>" + key + ": " + biography[key] + "</li>";
                }
            }
            if (showBio) {
                document.getElementById("biography").innerHTML = '<ul>' + showBio + '</ul>';
            }*/
        }
    }
    document.getElementById("report").innerHTML = "<p style='text-align: center;'>No errors reported for this data set.</p>"
    requestObj.open("Get", reportUrl, true);
    requestObj.send();

    // Other data sets from the same site
    siteCode = pid.split('.')[0];
    var otherReportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+like+%27" + siteCode + "%%27&returnGeometry=true&outFields=report&f=pjson"
    var otherRequestObj = new XMLHttpRequest();
    otherRequestObj.onreadystatechange = function() {
        if (otherRequestObj.readyState == 4 && (otherRequestObj.status == 200 || otherRequestObj.status == 304)) {
            var responseJson = otherRequestObj.responseText;
            var response = JSON.parse(responseJson);
            var errReport = response.features[0].attributes.report;
            errReport = "<p>" + createLinks(errReport) + "</p>"
            document.getElementById("site-report").innerHTML = errReport;
        }
    }
    document.getElementById("site-report").innerHTML = "<p>Other package list goes here</p>" 
    otherRequestObj.open("Get", otherReportUrl, true);
    otherRequestObj.send();
}
</script>

</body>
</html>