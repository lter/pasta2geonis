<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>GeoNIS Spatial Data Report</title>
<link rel="stylesheet" type="text/css" href="css/report.css" />
<link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
<!--<script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>-->
<script type="text/javascript">
function getPID() {
    var searchStr = window.location.search;
    if (searchStr.length > 1) {
        searchStr = searchStr.substring(1);
    }
    else {
       return "";
    }
    searchItems = searchStr.split('&');
    for(var i = 0; i < searchItems.length; i++) {
        var item = searchItems[i].split('=');
        if (item[0] == "packageid") {
            return item[1];
        }
    }
    return "";
}

function createLinks(errReport) {
    if (typeof errReport !== 'undefined') {
        var regex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return errReport.replace(regex, "<a href='$1'>$1</a>");
    }
    else {
        return errReport;
    }
}

/**
 * Parse the raw error report which we fetched from the database using the
 * Search service, which has the following pipe-delimited structure:
 * error report | JSON string containing various package + entity information
 */
function parseReport(rawReport) {
    splitPipe = rawReport.split('|');
    report = "<ul><li>" + splitPipe[0];
    report += "</li>";
    return {
        'report': report.replace(/\n/g, '<br />'),
        'biography': JSON.parse(splitPipe[1])
    };
}

/** 
 * Check the package and entity tables for error reports, and append them to the
 * active error report if found.
 */
function checkTables(biography, report) {
    report = (biography['entityname'] === null) ? 
        checkPackage(biography, report) : checkEntity(biography, report);
    return report;
}

/**
 * Check for report entries in the entity table, and append them to its error report.
 */
function checkPackage(biography, report) {
    report = "<span class='entity-name'>Package report</span>" + report;
    return report;
}

/**
 * Check for report entries in the entity table, and append them to its error report.
 */
function checkEntity(biography, report) {
    var mapService = (biography['mxd'] === null) ?
        biography['entityname'] + " is not available as a map service due to errors." :
        "<a href='" + biography['service'].split('/').slice(0, -1).join('/') + "'>" + 
            biography['entityname'] + " is available as a map service.</a>"
    var spatialType = (biography['israster'] === 't') ? "raster" : "vector";
    report = "<span class='entity-name'>" + biography['entityname'] + "</span> \
        (" + spatialType + ")" + report + "<li>" + mapService + "</li>";
    return report;
}

/**
 * Replaces the default "Searching for package..." with a readable site ID: revision
 * banner, and determines whether this package was retrieved from the staging
 * (pasta-s.lternet.edu) or live (pasta.lternet.edu) server.
 */
function generateBanner(biography) {
    if (biography['scope'] !== 'undefined') {
        document.getElementById("pid").innerHTML = biography['scope'].toUpperCase() + 
            " " + biography['identifier'] + ", revision " + biography['revision'];
    }
    var serverInfo;
    if (biography['pasta'].indexOf('pasta-s') !== -1) {
        serverInfo = {
            'server': 'staging',
            'baseURL': 'pasta-s.lternet.edu'
        };
    }
    else {
        serverInfo = {
            'server': 'live',
            'baseURL': 'pasta.lternet.edu'
        };
    }
    return serverInfo;
}

/**
 * Appends HTML to a div.
 */
function insertReport(report, reportDiv, isFirstReport) {
    if (isFirstReport) {
        document.getElementById(reportDiv).innerHTML = report;
    }
    else {
        var nextReport = document.createElement('div');
        nextReport.innerHTML = report;
        while (nextReport.firstChild) {
            document.getElementById(reportDiv).appendChild(nextReport.firstChild);
        }
    }
}

Array.prototype.getUnique = function () {
    var u = {}, a = [];
    for(var i = 0, l = this.length; i < l; ++i){
        if(u.hasOwnProperty(this[i])) {
            continue;
        }
        a.push(this[i]);
        u[this[i]] = 1;
    }
    return a;
}

Array.prototype.sortNumeric = function () {
    var tempArr = [], n;
    for (var i in this) {
        tempArr[i] = this[i].toString().match(/([^0-9]+)|([0-9]+)/g);
        for (var j in tempArr[i]) {
            if (!isNaN(n = parseInt(tempArr[i][j]))){
                tempArr[i][j] = n;
            }
        }
    }
    tempArr.sort(function (x, y) {
        for (var i in x) {
            if (y.length < i || x[i] < y[i]) {
                return -1; // x is longer
            }
            if (x[i] > y[i]) {
                return 1;
            }
        }
        return 0;
    });
    for (var i in tempArr) {
        this[i] = tempArr[i].join('');
    }
    return this;
}
</script>
</head>
<body>
<div class="wrapper">
<div id="body_wrapper">

    <div id="header">
        <div id="header-content">
            <div id="site_title"><h1>GeoNIS Spatial Data Report</h1></div>
        <div class="cleaner"></div>
        </div>
    </div>

    <div id="wrapper">
        <div class="banner">
            <h2 id="pid">Searching for package...</h2>
            <div id="report"></div>
            <!--<div id="biography"></div>-->
            <div id="workflow-info"></div>
        </div>
        <div class="leftbar">
            <div id="site-report-title"></div>
            <div id="site-report"></div>
        </div>
        <!--<div class="banner">
            <div id="all-report-title"></div>
            <div id="all-report"></div>
        </div>-->
        <div class="cleaner"></div> 
    </div>

    <div class="cleaner"></div>
    <div class="push"></div>
</div>

<!--<div id="footer_wrapper">
    <div id="footer-outer">
        <div id="footer">
            <div id="copyright">
                Copyright &copy; 2013 <a href="http://www.lternet.edu/">Long Term Ecological Research Network</a>
            </div> 
        </div> 
    </div>
</div>-->

<script type="text/javascript">
var pid = getPID();
if (pid != "") {
    document.getElementById("pid").innerHTML = pid;
    var reportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+%3D+%27" + pid + "%27&returnGeometry=true&outFields=report&f=pjson";
    var requestObj = new XMLHttpRequest();
    requestObj.onreadystatechange = function() {
        if (requestObj.readyState == 4 && (requestObj.status == 200 || requestObj.status == 304)) {
            var responseJson = requestObj.responseText;
            var response = JSON.parse(responseJson);

            // The error report is pipe-delimited from other useful info stored in
            // the report field, in stringified-JSON format
            var replaceBanner = false;
            for (var i = 0; i < response.features.length; i++) {

                // First parse the raw report
                parsedReport = parseReport(response.features[i].attributes.report);
                var report = parsedReport.report;
                var biography = parsedReport.biography;
                report = checkTables(biography, report);
                
                // Generate a banner with the site name, id, and revision, if we haven't
                // done so already
                if (!replaceBanner) {
                    var serverInfo = generateBanner(biography);
                    replaceBanner = true;
                }

                // Insert the reports into the report div
                insertReport('<p>' + report + '</p>', 'report', i == 0);
            }
            
            // Append server information and download link to the bottom of the report
            var packageLink = "<a href='https://" + serverInfo['baseURL'] + "/package/eml/" +
                biography['packageid'].split('.')[0] + "/" + biography['identifier'] +
                "/" + biography['revision'] + "'>" + biography['packageid'] + "</a>";
            document.getElementById('workflow-info').innerHTML = "<hr />\
                <em>Package " + packageLink + " was downloaded from the <a href='https://" + 
                serverInfo.baseURL + "'>" + serverInfo.server + 
                " server</a> on " + biography['downloaded'].split(' ')[0] + " at " + 
                biography['downloaded'].split(' ')[1].split('.')[0] + " MDT.</em>";
        }
    }
    document.getElementById("report").innerHTML = "<p style='text-align: center;'>Data set not found.</p>"
    requestObj.open("Get", reportUrl, true);
    requestObj.send();

    // Other data sets from the same site
    siteCode = pid.split('.')[0];
    var otherReportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+like+%27" + siteCode + "%%27&returnGeometry=true&f=pjson"
    var otherRequestObj = new XMLHttpRequest();
    otherRequestObj.onreadystatechange = function() {
        if (otherRequestObj.readyState == 4 && (otherRequestObj.status == 200 || otherRequestObj.status == 304)) {
            var responseJson = otherRequestObj.responseText;
            var response = JSON.parse(responseJson);
            sitePackageArray = [];
            for (var i = 0; i < response.features.length; i++) {
                sitePackageArray.push(response.features[i].attributes.packageid);
            }
            sitePackageArray = sitePackageArray.getUnique().sortNumeric();
            document.getElementById('site-report-title').innerHTML = "<p><span class='entity-name'>" + 
                siteCode.split('-').slice(-1)[0].toUpperCase() + " (" + sitePackageArray.length + 
                " packages)</span></p>";
            var sitePackages = '';
            for (var i = 0; i < sitePackageArray.length; i++) {
                sitePackages += '<li><a href="report.html?packageid=' + sitePackageArray[i] + '">' + 
                    sitePackageArray[i] + '</a></li>';
            }
            document.getElementById('site-report').innerHTML = '<ul>' + sitePackages + '</ul>';
        }
    }
    otherRequestObj.open("Get", otherReportUrl, true);
    otherRequestObj.send();

    /*var allReportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+like+%27knb-lter%%%27&returnGeometry=true&f=pjson"
    var allRequestObj = new XMLHttpRequest();
    allRequestObj.onreadystatechange = function() {
        if (allRequestObj.readyState == 4 && (allRequestObj.status == 200 || allRequestObj.status == 304)) {
            var responseJson = allRequestObj.responseText;
            var response = JSON.parse(responseJson);
            document.getElementById('all-report-title').innerHTML = "<p><span class='entity-name'>Found " + 
                response.features.length + " other packages</span></p>";
            for (var i = 0; i < response.features.length; i++) {
                insertReport(
                    '<ul><li>' + response.features[i].attributes.packageid + '</li>', 
                    'all-report', 
                    i == 0
                );
            }
        }
    }
    allRequestObj.open("Get", allReportUrl, true);
    allRequestObj.send();*/
}
</script>

</body>
</html>