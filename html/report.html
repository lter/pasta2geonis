<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<title>GeoNIS Spatial Data Report</title>
<link rel="stylesheet" type="text/css" href="css/report.css" />
<link href='http://fonts.googleapis.com/css?family=Lato:300' rel='stylesheet' type='text/css'>
<script type="text/javascript">
function getPID() {
    var searchStr = window.location.search;
    if (searchStr.length > 1) {
        searchStr = searchStr.substring(1);
    }
    else {
       return "";
    }
    searchItems = searchStr.split('&');
    for(var i = 0; i < searchItems.length; i++) {
        var item = searchItems[i].split('=');
        if (item[0] == "packageid") {
            return item[1];
        }
    }
    return "";
}

function createLinks(errReport) {
    if (typeof errReport !== 'undefined') {
        var regex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        return errReport.replace(regex, "<a href='$1'>$1</a>");
    }
    else {
        return errReport;
    }
}
</script>
</head>
<body>
<div class="wrapper">
<div id="body_wrapper">

    <div id="header">
        <div id="header-content">
            <div id="site_title"><h1>GeoNIS Spatial Data Report</h1></div>
        <div class="cleaner"></div>
        </div>
    </div>

    <div id="wrapper">
        <div id="banner">
            <h2 id="pid">Searching for package...</h2>
            <div id="report"></div>
            <!--<div id="biography"></div>-->
            <div id="workflow-info"></div>
            <!--<div id="site-report"></div>-->
            <div class="push"></div>
        </div>
        <div class="cleaner"></div> 
    </div>

    <div class="cleaner"></div>
</div>

<div id="footer_wrapper">
    <div id="footer-outer">
        <div id="footer">
            <div id="copyright">
                Copyright &copy; 2013 <a href="http://www.lternet.edu/">Long Term Ecological Research Network</a>
            </div> 
        </div> 
    </div>
</div>

<script type="text/javascript">
var pid = getPID();
if (pid != "") {
    document.getElementById("pid").innerHTML = pid;
    var reportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+%3D+%27" + pid + "%27&returnGeometry=true&outFields=report&f=pjson"
    var requestObj = new XMLHttpRequest();
    requestObj.onreadystatechange = function() {
        if (requestObj.readyState == 4 && (requestObj.status == 200 || requestObj.status == 304)) {
            var responseJson = requestObj.responseText;
            var response = JSON.parse(responseJson);

            // The error report is pipe-delimited from other useful info stored in
            // the report field, in stringified-JSON format
            var rawErrReport = new Array();
            var errReport = new Array();
            var replaceBanner = false;
            for (var i = 0; i < response.features.length; i++) {
                rawErrReport.push(response.features[i].attributes.report.split('|'));
                errReport.push("<ul><li>" + rawErrReport[i][0]);
                if (errReport[i].charAt(errReport[i].length-1) !== '.' && errReport[i].charAt(errReport[i].length-1) !== '!' && errReport[i].charAt(errReport[i].length-1) !== '?') {
                    while (errReport[i].charAt(errReport[i].length-1) == ' ') {
                        errReport[i] = errReport[i].slice(0, -1);
                    }
                    errReport[i] += '.';
                }
                errReport[i] += "</li>";

                // Basic 'biographical' info stuff: parse the biography JSON string stored after the pipe
                if (rawErrReport[i].length > 1) {
                    var biography = JSON.parse(rawErrReport[i][1]);
                    var mapService = (biography['mxd'] === null) ?
                        biography['entityname'] + " is not available as a map service due to errors." :
                        "<a href='" + biography['service'].split('/').slice(0, -1).join('/') + "'>" + biography['entityname'] + " is available as a map service.</a>"
                    var spatialType = (biography['israster'] === 't') ? "raster" : "vector";
                    errReport[i] = "<span class='entity-name'>" + biography['entityname'] + "</span> (" + spatialType + ")" + errReport[i] + "<li>" + mapService + "</li>";
                    if (!replaceBanner) {
                        if (biography['scope'] !== 'undefined') {
                            document.getElementById("pid").innerHTML = biography['scope'].toUpperCase() + " " + biography['identifier'] + ", revision " + biography['revision'];
                            replaceBanner = true;
                        }
                        if (biography['pasta'].indexOf('pasta-s') !== -1) {
                            serverName = 'staging';
                            baseURL = 'pasta-s.lternet.edu';
                        }
                        else {
                            serverName = 'live';
                            baseURL = 'pasta.lternet.edu';
                        }
                    }
                }
                else {
                    continue;
                }

                // Error reports
                if (i == 0) {
                    document.getElementById('report').innerHTML = "<p>" + errReport[i] + "</p></ul>";
                }
                else {
                    var nextReport = document.createElement('div');
                    nextReport.innerHTML = "<p>" + errReport[i] + "</p></ul>";
                    while (nextReport.firstChild) {
                        document.getElementById('report').appendChild(nextReport.firstChild);
                    }
                }

            }
            
            // Append server information and download link to the bottom of the report
            document.getElementById('workflow-info').innerHTML = "<hr /><em>Package <a href='https://" + baseURL + "/package/eml/" + biography['packageid'].split('.')[0] + "/" + biography['identifier'] + "/" + biography['revision'] + "'>" + biography['packageid'] + "</a> was downloaded from the " + serverName + " server (<a href='https://" + baseURL + "'>" + baseURL + "</a>) on " + biography['downloaded'].split(' ')[0] + " at " + biography['downloaded'].split(' ')[1].split('.')[0] + " MDT.</em>";

            /*var showBio = '';
            for (var key in biography) {
                if (biography.hasOwnProperty(key)) {
                    showBio = showBio + "<li>" + key + ": " + biography[key] + "</li>";
                }
            }
            if (showBio) {
                document.getElementById("biography").innerHTML = '<ul>' + showBio + '</ul>';
            }*/
        }
    }
    document.getElementById("report").innerHTML = "<p style='text-align: center;'>No errors reported for this data set.</p>"
    requestObj.open("Get", reportUrl, true);
    requestObj.send();

    // Other data sets from the same site
    /*siteCode = pid.split('.')[0];
    var otherReportUrl = "http://maps3.lternet.edu/arcgis/rest/services/Test/Search/MapServer/2/query?where=packageid+like+%27" + siteCode + "%%27&returnGeometry=true&outFields=report&f=pjson"
    var otherRequestObj = new XMLHttpRequest();
    otherRequestObj.onreadystatechange = function() {
        if (otherRequestObj.readyState == 4 && (otherRequestObj.status == 200 || otherRequestObj.status == 304)) {
            var responseJson = otherRequestObj.responseText;
            var response = JSON.parse(responseJson);
            var errReport = response.features[0].attributes.report;
            errReport = "<p>" + createLinks(errReport) + "</p>"
            document.getElementById("site-report").innerHTML = errReport;
        }
    }
    document.getElementById("site-report").innerHTML = "<p>Other package list goes here</p>" 
    otherRequestObj.open("Get", otherReportUrl, true);
    otherRequestObj.send();*/
}
</script>

</body>
</html>